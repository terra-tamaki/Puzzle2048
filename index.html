<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle2048 - 美しいアニメーションの2048パズル</title>
    <link rel="stylesheet" href="css/puzzle2048-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ゲームヘッダー -->
    <div class="game-header">
        <div class="score-section">
            <div class="score-item">
                <div class="score-label">スコア</div>
                <div class="score-value" id="current-score">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">ベスト</div>
                <div class="score-value" id="best-score">0</div>
            </div>
        </div>
        <div class="header-buttons">
            <button class="restart-btn" id="restart-button">リスタート</button>
            <button class="demo-btn" id="demo-button">🤖 デモ</button>
            <button class="settings-btn" id="settings-button">⚙️</button>
        </div>
    </div>

    <!-- ゲームコンテナ -->
    <div class="game-container">
        <div class="game-grid" id="game-grid">
            <!-- 空のグリッドセル -->
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
        </div>

        <!-- ゲームオーバーレイ（勝利・敗北時） -->
        <div class="game-overlay" id="game-overlay">
            <div class="overlay-message" id="overlay-message">🎉 2048達成！</div>
            <div class="overlay-submessage" id="overlay-submessage">継続しますか？</div>
            <div class="overlay-buttons">
                <button class="overlay-btn primary" id="continue-button">継続</button>
                <button class="overlay-btn secondary" id="restart-from-overlay">リスタート</button>
                <button class="overlay-btn secondary" id="view-result">結果を見る</button>
            </div>
        </div>
    </div>

    <!-- 操作ガイド -->
    <div class="controls-guide">
        <div class="controls-title">操作方法</div>
        <div class="controls-grid">
            <div class="control-item">
                <div class="control-key">↑↓←→</div>
                <div class="control-desc">タイル移動</div>
            </div>
            <div class="control-item">
                <div class="control-key">R</div>
                <div class="control-desc">リスタート</div>
            </div>
            <div class="control-item">
                <div class="control-key">ESC</div>
                <div class="control-desc">一時停止</div>
            </div>
            <div class="control-item">
                <div class="control-key">M</div>
                <div class="control-desc">ミュート</div>
            </div>
        </div>
    </div>

    <!-- デモコントロール（デモ実行中のみ表示） -->
    <div class="demo-controls" id="demo-controls" style="display: none;">
        <div class="demo-status">
            <span id="demo-status">🤖 デモプレイ中...</span>
            <span id="demo-moves">手数: 0</span>
        </div>
        <div class="demo-buttons">
            <button class="demo-control-btn" id="demo-pause">⏸️</button>
            <button class="demo-control-btn" id="demo-stop">⏹️</button>
            <select class="demo-speed" id="demo-speed">
                <option value="0.5">0.5倍速</option>
                <option value="1" selected>標準</option>
                <option value="2">2倍速</option>
                <option value="3">3倍速</option>
            </select>
        </div>
    </div>

    <!-- ゲーム統計表示（デバッグ用） -->
    <div class="debug-info" id="debug-info" style="display: none;">
        <div>手数: <span id="moves-count">0</span></div>
        <div>合体回数: <span id="merge-count">0</span></div>
        <div>最高タイル: <span id="max-tile">0</span></div>
        <div>状態: <span id="game-status">playing</span></div>
    </div>

    <!-- JavaScript -->
    <script src="js/game-engine.js"></script>
    <script src="js/animation-controller.js"></script>
    <script src="js/audio-manager.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/demo-ai.js"></script>
    <script>
        // 設定読み込みとゲーム初期化
        document.addEventListener('DOMContentLoaded', function() {
            // URLパラメータまたは保存された設定を読み込み
            const urlParams = new URLSearchParams(window.location.search);
            let settings = {};
            
            try {
                const savedSettings = localStorage.getItem('puzzle2048_settings');
                settings = savedSettings ? JSON.parse(savedSettings) : {};
            } catch (error) {
                console.warn('設定読み込みエラー:', error);
            }
            
            // URLパラメータで設定を上書き
            const difficulty = urlParams.get('difficulty') || settings.difficulty || 'easy';
            const volume = parseInt(urlParams.get('volume')) || settings.volume || 70;
            const muted = urlParams.get('muted') === 'true' || settings.muted || false;
            const animationSpeed = parseInt(urlParams.get('animationSpeed')) || settings.animationSpeed || 2;
            const showDebug = urlParams.get('showDebug') === 'true' || settings.showDebug || false;
            
            // 難易度に応じたゲームエンジン初期化
            const gameEngine = new GameEngine(difficulty);
            const uiController = new UIController(gameEngine);
            
            // 設定を適用
            uiController.audioManager.setVolume(volume / 100);
            if (muted) uiController.audioManager.toggleMute();
            uiController.animationController.setSpeed(animationSpeed);
            
            // デバッグ表示設定
            if (showDebug) {
                document.getElementById('debug-info').style.display = 'block';
            }
            
            // 設定ボタンのイベントリスナー
            document.getElementById('settings-button').addEventListener('click', () => {
                window.location.href = 'settings.html';
            });
            
            // デバッグモード（開発用）
            window.game = gameEngine;
            window.ui = uiController;
            window.animations = uiController.animationController;
            window.audio = uiController.audioManager;
            
            // デモAI初期化
            window.demoAI = new DemoAI(gameEngine);
            
            // デモボタンイベント
            document.getElementById('demo-button').addEventListener('click', function() {
                if (window.demoAI.isRunning) {
                    window.demoAI.stopDemo();
                    this.textContent = '🤖 デモ';
                    document.getElementById('demo-controls').style.display = 'none';
                } else {
                    window.demoAI.startDemo();
                    this.textContent = '⏹️ 停止';
                    document.getElementById('demo-controls').style.display = 'flex';
                }
            });
            
            // デモコントロールイベント
            document.getElementById('demo-pause').addEventListener('click', function() {
                window.demoAI.togglePause();
                this.textContent = window.demoAI.isPaused ? '▶️' : '⏸️';
            });
            
            document.getElementById('demo-stop').addEventListener('click', function() {
                window.demoAI.stopDemo();
                document.getElementById('demo-button').textContent = '🤖 デモ';
                document.getElementById('demo-controls').style.display = 'none';
            });
            
            document.getElementById('demo-speed').addEventListener('change', function() {
                const speed = parseFloat(this.value);
                window.demoAI.setSpeed(speed);
            });
            
            console.log(`🎮 Puzzle2048 ゲーム開始！ (難易度: ${difficulty})`);
            console.log('矢印キーでタイルを移動してください');
            console.log('F12: デバッグモード | M: ミュート切り替え | ⚙️: 設定 | 🤖: デモプレイ');
            console.log('音響システムは最初の操作で初期化されます');
        });
    </script>
</body>
</html>